# -*- coding: utf-8 -*-
"""Untitled10.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1uvurbOB6MfIC2D_E_zFy63V3u6bR--lL
"""

!pip install xgboost

import pandas as pd
import numpy as np

train = pd.read_csv("/content/train.csv")
test = pd.read_csv("/content/test.csv")

train.drop("ADDRESS", axis=1, inplace=True)
test.drop("ADDRESS", axis=1, inplace=True)

# One-hot encoding
train = pd.get_dummies(train, drop_first=True)
test = pd.get_dummies(test, drop_first=True)

# Align columns
train, test = train.align(test, join="left", axis=1, fill_value=0)

X = train.drop("TARGET(PRICE_IN_LACS)", axis=1)
y = train["TARGET(PRICE_IN_LACS)"]

from sklearn.model_selection import train_test_split

X_train, X_val, y_train, y_val = train_test_split(
    X, y, test_size=0.2, random_state=42
)

from xgboost import XGBRegressor

xgb_model = XGBRegressor(
    n_estimators=300,
    learning_rate=0.05,
    max_depth=6,
    subsample=0.8,
    colsample_bytree=0.8,
    random_state=42
)

xgb_model.fit(X_train, y_train)

from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score

preds = xgb_model.predict(X_val)

print("MAE:", mean_absolute_error(y_val, preds))
print("RMSE:", np.sqrt(mean_squared_error(y_val, preds)))
print("R2 Score:", r2_score(y_val, preds))

xgb_model.fit(X, y)

import pickle

pickle.dump(xgb_model, open("xgboost_model.pkl", "wb"))
pickle.dump(X.columns, open("columns.pkl", "wb"))

model = pickle.load(open("xgboost_model.pkl", "rb"))

!pip install flask pyngrok xgboost

import os

os.makedirs("templates", exist_ok=True)
os.makedirs("static", exist_ok=True)

# Commented out IPython magic to ensure Python compatibility.
# %%writefile templates/index.html
# <!DOCTYPE html>
# <html>
# <head>
#     <title>House Price Prediction</title>
#     <link rel="stylesheet" href="/static/style.css">
# </head>
# <body>
#     <div class="container">
#         <h2>üè† House Price Prediction</h2>
# 
#         <form method="POST" action="/predict">
#             <input type="number" name="SQUARE_FT" placeholder="Square Feet" required>
#             <input type="number" name="BHK_NO." placeholder="BHK" required>
#             <input type="number" step="any" name="LATITUDE" placeholder="Latitude" required>
#             <input type="number" step="any" name="LONGITUDE" placeholder="Longitude" required>
# 
#             <select name="READY_TO_MOVE">
#                 <option value="1">Ready to Move</option>
#                 <option value="0">Not Ready</option>
#             </select>
# 
#             <select name="UNDER_CONSTRUCTION">
#                 <option value="0">Not Under Construction</option>
#                 <option value="1">Under Construction</option>
#             </select>
# 
#             <button type="submit">Predict</button>
#         </form>
# 
#         {% if prediction %}
#         <h3>üí∞ Predicted Price: {{ prediction }} Lakhs</h3>
#         {% endif %}
#     </div>
# </body>
# </html>
#

# Commented out IPython magic to ensure Python compatibility.
# %%writefile static/style.css
# body {
#     background: #f2f2f2;
#     font-family: Arial, sans-serif;
# }
# 
# .container {
#     width: 380px;
#     background: white;
#     padding: 25px;
#     margin: 80px auto;
#     border-radius: 12px;
#     box-shadow: 0 0 15px rgba(0,0,0,0.2);
#     text-align: center;
# }
# 
# input, select, button {
#     width: 100%;
#     padding: 10px;
#     margin: 8px 0;
# }
# 
# button {
#     background: #0d6efd;
#     color: white;
#     border: none;
#     font-size: 15px;
#     cursor: pointer;
# }
# 
# button:hover {
#     background: #084298;
# }
#

from flask import Flask, render_template, request
import numpy as np
import pickle
from pyngrok import ngrok

app = Flask(__name__)

# Load XGBoost model and columns
model = pickle.load(open("xgboost_model.pkl", "rb"))
columns = pickle.load(open("columns.pkl", "rb"))

@app.route("/")
def home():
    return render_template("index.html")

@app.route("/predict", methods=["POST"])
def predict():
    input_data = np.zeros(len(columns))

    for i, col in enumerate(columns):
        if col in request.form:
            input_data[i] = float(request.form[col])

    prediction = model.predict([input_data])[0]

    return render_template(
        "index.html",
        prediction=round(prediction, 2)
    )

# üîë Add your ngrok authtoken
ngrok.set_auth_token("398zt9Ix9bV0pczgP9gQ3IOB3jC_2tWwRcBRkPcHj244XgpQV")

# Start ngrok tunnel
public_url = ngrok.connect(5000)
print("üåç Website URL:", public_url)

# Run Flask
app.run(port=5000)